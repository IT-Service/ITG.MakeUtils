%!PS-Adobe-2.0
%%Creator: Sergei S. Betke
%%Title: CSM makrs
%%Pages: 1
%%PageOrder: Ascend
%%BoundingBox: 0 0 585 842
%%EndComments

/CP1251Encoding 256 array def
CP1251Encoding 0  StandardEncoding 0 128 getinterval  putinterval
CP1251Encoding 128 [
  /afii10051 /afii10052 /quotesinglbase /afii10100 /quotedblbase /ellipsis /dagger /daggerdbl
  /Euro /perthousand /afii10058 /guilsinglleft /afii10059 /afii10061 /afii10060 /afii10145
  /afii10099 /quoteleft /quoteright /quotedblleft /quotedblright /bullet /endash /emdash
  /tilde /trademark /afii10106 /guilsinglright /afii10107 /afii10109 /afii10108 /afii10193
  /space /afii10062 /afii10110 /afii10057 /currency /afii10050 /brokenbar /section
  /afii10023 /copyright /afii10053 /guillemotleft /logicalnot /hyphen /registered /afii10056
  /degree /plusminus /afii10055 /afii10103 /afii10098 /mu1 /paragraph /periodcentered
  /afii10071 /afii61352 /afii10101 /guillemotright /afii10105 /afii10054 /afii10102 /afii10104
  /afii10017 /afii10018 /afii10019 /afii10020 /afii10021 /afii10022 /afii10024 /afii10025
  /afii10026 /afii10027 /afii10028 /afii10029 /afii10030 /afii10031 /afii10032 /afii10033
  /afii10034 /afii10035 /afii10036 /afii10037 /afii10038 /afii10039 /afii10040 /afii10041
  /afii10042 /afii10043 /afii10044 /afii10045 /afii10046 /afii10047 /afii10048 /afii10049
  /afii10065 /afii10066 /afii10067 /afii10068 /afii10069 /afii10070 /afii10072 /afii10073
  /afii10074 /afii10075 /afii10076 /afii10077 /afii10078 /afii10079 /afii10080 /afii10081
  /afii10082 /afii10083 /afii10084 /afii10085 /afii10086 /afii10087 /afii10088 /afii10089
  /afii10090 /afii10091 /afii10092 /afii10093 /afii10094 /afii10095 /afii10096 /afii10097 
] putinterval

% перевод из миллиметров в пункты
/mm { 72.0 mul 25.4 div } def

/tan {
  dup
  sin
  exch cos
  div
}
def

/stringheight {
  gsave
    newpath
    0 0 moveto
    false charpath pathbbox exch pop sub exch pop
  grestore
}
def

/string_center_bottom {
  dup
    stringwidth pop  2 div  neg
    0
  rmoveto
}
def

/string_center_middle {
  dup
    dup stringwidth pop 2 div neg
    exch stringheight 2 div
  rmoveto
}
def

/string_left_middle {
  dup
    0
    exch stringheight 2 div
  rmoveto
}
def

/string_right_middle {
  dup
    dup stringwidth pop neg
    exch stringheight 2 div
  rmoveto
}
def

/arc_angle_from {
  5 dict begin
  /y1 exch def
  /x1 exch def
  /r exch def
  /yc exch def
  /xc exch def
    xc yc r
    y1 yc sub  x1 xc sub  atan
  end
}
def

/arc_angle_to {
  6 dict begin
  /y2 exch def
  /x2 exch def
  /a1 exch def
  /r exch def
  /yc exch def
  /xc exch def
    xc yc r a1
    y2 yc sub  x2 xc sub  atan
  end
}
def

(GOST2.304-81TypeA) findfont
dup length dict begin
  { 1 index /FID ne
    {def}
    {pop pop}
    ifelse
  } forall
  /Encoding CP1251Encoding def
  currentdict
end
(stamp_sign) exch definefont pop

(GOST2.304-81TypeA) findfont
dup length dict begin
  { 1 index /FID ne
    {def}
    {pop pop}
    ifelse
  } forall
  /Encoding CP1251Encoding def
  currentdict
end
(stamp_id) exch definefont pop

(GOST2.304-81TypeA) findfont
(stamp_period) exch definefont pop

(GOST2.304-81TypeA) findfont
(stamp_year) exch definefont pop

% знак РСТ
/RST {
  10 dict begin
  /H exch def % параметр H (высота) знака
  /x1  15 tan  H 2 div  mul  neg  def
  /R1  H  H 2 div  15 cos  div  sub  def
  /x2  0.17 H mul  def
  /y2  R1 dup mul  x2 x1 sub  dup mul  sub  sqrt  def
  /R2  y2  0.25 H mul  add  def
  /x4  0.5 H mul  def
  /y4  3 sqrt  2 div  H mul  H 2 div  sub  def
  /x5  x4  def
  /y5  R2 dup mul  x5 x2 sub  dup mul  sub  sqrt  y2 sub  def
  
  % сохраняем на стеке текущую матрицу преобразования системы координат для последующего восстановления
  matrix currentmatrix
  % переносим начало координат в центр символа РСТ
  currentpoint translate

  % С
  x4 y4 moveto
    0  H 2 div neg  H
    x4 y4 arc_angle_from
    105
  arc
  x1 0 R1 105 255 arc
    0  H 2 div  H
    255
    x4  y4 neg  arc_angle_to
  arc
  x5  y5 neg  lineto
    x2 y2 R2
    x5  y5 neg  arc_angle_from
    270
  arcn
  x2 0  0.25 H mul  270 90 arcn
    x2  y2 neg  R2
    90
    x5 y5  arc_angle_to
  arcn
  closepath
  
  % Т
    0.5  0.18 2 div  add  H mul
    0.25 H mul  2 div  neg
  moveto
  0  0.25 0.1 sub  H mul  rlineto
  0.35 0.18 sub  2 div  H mul  0  rlineto
  0  0.1 H mul  rlineto
  0.35 H mul neg  0  rlineto
  0  0.1 H mul neg  rlineto
  0.35 0.18 sub  2 div  H mul  0  rlineto
  0  0.25 0.1 sub  H mul  neg  rlineto
  closepath
  
  % р
    0.31 0.08 add H mul neg
    0.28 H mul neg
  moveto
    0.31 0.08 add H mul neg
    0.28 0.1 sub H mul neg
    0.1 H mul
    270 180
  arcn
  0  0.18 0.1 add H mul  rlineto
    0.31 H mul neg
    0.1 H mul
    0.18 H mul
    180
    -0.18  0.08 0.04 sub neg  atan
  arcn
  %  0  0.1 H mul  rlineto
    0.31 H mul neg
    0.1 H mul
    0.08 H mul
    -0.08  0.08 0.04 sub neg  atan
    180
  arc
  closepath

  % восстановливаем систему координат
  setmatrix

  end
}
def

% генерация рисунка поверительного клейма
/verification_stamp {
  6 dict begin
  /size exch def % размер клейма
  /verification_stamp_sign exch def % индивидуальный знак поверителя
  /verification_stamp_id exch def % шифр поверительного клейма
  /verification_stamp_period exch def % идентификация периода для месячных и квартальных клейм
  /verification_stamp_year exch def % год поверительного клейма
  /scale_k size 18 div def % рассчитаем коэффициент для последующего масштабирования

  % сохраняем на стеке текущую матрицу преобразования системы координат для последующего восстановления
  matrix currentmatrix
  % переносим начало координат в центр символа РСТ
  currentpoint translate
  scale_k scale_k scale % масштабируем пространство для отрисовки из 18 единиц в заданный размер клейма

  % окружность
  18 2 div  0  moveto
  0 0  18 2 div  0 360 arc  closepath
  18 2 div 0.5 sub  0  moveto
  0 0  18 2 div 0.5 sub  360 0 arcn  closepath
  
  % шифр поверительного клейма организации
  (stamp_id) findfont
  4 scalefont setfont
  0 -5.5 moveto
    verification_stamp_id
    string_center_middle
  true charpath

  % индивидуальный знак поверителя
  (stamp_sign) findfont
  4 scalefont setfont
  0 0 moveto
    verification_stamp_sign
    string_center_middle 
  true charpath
  
  % год
  (stamp_year) findfont
  6 scalefont setfont
  -7 0 moveto
        verification_stamp_year 4 string cvs
        dup length 2 sub
        1
      getinterval
    string_left_middle 
  true charpath
  7 0 moveto
        verification_stamp_year 4 string cvs
        dup length 1 sub
        1
      getinterval
    string_right_middle 
  true charpath

  % период
  (stamp_period) findfont
  3 scalefont setfont
  -2.5 5 moveto
    verification_stamp_period
    string_center_middle
  true charpath

  % знак РСТ
  2.5 5 moveto
  3 RST
  
  % восстановливаем систему координат
  setmatrix

  end
}
def

% генерация рисунка калибровочного клейма
/calibration_stamp {
}
def

%%EndProlog

%%BeginSetup
%%Feature: *Resolution 600dpi
%%EndSetup

%%Page: A 1
%%BeginSetup
%%BeginFeature: *PageSize A4
<</PageSize [595 842] /ImagingBBox null>> setpagedevice
%%EndFeature
%%EndSetup

% начальные служебные инструкции закончены

gsave

60 mm 220 mm moveto
2017 (IV) (СП) (а) 100.0 mm verification_stamp
fill
% 0.1 setlinewidth
% stroke

grestore
showpage

%%PageTrailer
%%Trailer
%%EOF

