%!PS-Adobe-2.0
%%Creator: Sergei S. Betke
%%Title: CSM makrs
%%Pages: 1
%%PageOrder: Ascend
%%EndComments

/setdistillerparams where {
  pop
  <<
    /AllowTransparency false
    /AutoRotatePages /All
    /Binding /Left
    /CompatibilityLevel 1.4
    /DefaultRenderingIntent /Default
    /DetectBlends true
    /DetectCurves 0.0000
    /ColorConversionStrategy /LeaveColorUnchanged
    /DoThumbnails false
    /CannotEmbedFontPolicy /Warning
    /EmbedAllFonts true
    /EmbedOpenType false
    /DSCReportingLevel 0
    /EmitDSCWarnings false
    /EndPage -1
    /Optimize true
    /OPM 1
    /ParseDSCComments true
    /ParseDSCCommentsForDocInfo true
    /PreserveFlatness true
    /PreserveOPIComments false
    /StartPage 1
    /SubsetFonts true
    /TransferFunctionInfo /Apply
    /UCRandBGInfo /Preserve
    /UsePrologue false
    /AlwaysEmbed [ true
    ]
    /NeverEmbed [ true
    ]
    /CheckCompliance [
      /None
    ]
    /PDFX1aCheck false
    /PDFX3Check false
    /PDFXCompliantPDFOnly false
    /PDFXNoTrimBoxError true
    /PDFXTrimBoxToMediaBoxOffset [
      0.00000
      0.00000
      0.00000
      0.00000
    ]
    /PDFXSetBleedBoxToMediaBox true
    /PDFXBleedBoxToTrimBoxOffset [
      0.00000
      0.00000
      0.00000
      0.00000
    ]
    /PDFXOutputIntentProfile (None)
    /PDFXOutputConditionIdentifier ()
    /PDFXOutputCondition ()
    /PDFXRegistryName ()
    /PDFXTrapped /False
    /CreateJDFFile false
    /Namespace [
      (Adobe)
      (Common)
      (1.0)
    ]
  >> setdistillerparams
} if

/GetPageBBox {
  currentpagedevice /ImagingBBox get
  dup type /nulltype eq
    {
      pop
        0 0
        currentpagedevice /PageSize get  aload  pop
        4 array
      astore
    }
  if
}
def

/CP1251Encoding [
  /null /controlSTX /controlSOT /controlETX /controlEOT /controlENQ /controlACK /controlBEL
  /controlBS /controlHT /controlLF /controlVT /controlFF /controlCR /controlSO /controlSI
  /controlDLE /controlDC1 /controlDC2 /controlDC3 /controlDC4 /controlNAK /controlSYN /controlETB
  /controlCAN /controlEM /controlSUB /controlESC /controlFS /controlGS /controlRS /controlUS
  /space /exclam /quotedbl /numbersign /dollar /percent /ampersand /quotesingle
  /parenleft /parenright /asterisk /plus /comma /hyphen /period /slash
  /zero /one /two /three /four /five /six /seven
  /eight /nine /colon /semicolon /less /equal /greater /question
  /at /A /B /C /D /E /F /G
  /H /I /J /K /L /M /N /O
  /P /Q /R /S /T /U /V /W
  /X /Y /Z /bracketleft /backslash /bracketright /asciicircum /underscore
  /grave /a /b /c /d /e /f /g
  /h /i /j /k /l /m /n /o
  /p /q /r /s /t /u /v /w
  /x /y /z /braceleft /bar /braceright /asciitilde /controlDEL
  /afii10051 /afii10052 /quotesinglbase /afii10100 /quotedblbase /ellipsis /dagger /daggerdbl
  /Euro /perthousand /afii10058 /guilsinglleft /afii10059 /afii10061 /afii10060 /afii10145
  /afii10099 /quoteleft /quoteright /quotedblleft /quotedblright /bullet /endash /emdash
  /null /trademark /afii10106 /guilsinglright /afii10107 /afii10109 /afii10108 /afii10193
  /nbspace /afii10062 /afii10110 /afii10057 /currency /afii10050 /brokenbar /section
  /afii10023 /copyright /afii10053 /guillemotleft /logicalnot /sfthyphen /registered /afii10056
  /degree /plusminus /afii10055 /afii10103 /afii10098 /mu /paragraph /middot
  /afii10071 /afii61352 /afii10101 /guillemotright /afii10105 /afii10054 /afii10102 /afii10104
  /afii10017 /afii10018 /afii10019 /afii10020 /afii10021 /afii10022 /afii10024 /afii10025
  /afii10026 /afii10027 /afii10028 /afii10029 /afii10030 /afii10031 /afii10032 /afii10033
  /afii10034 /afii10035 /afii10036 /afii10037 /afii10038 /afii10039 /afii10040 /afii10041
  /afii10042 /afii10043 /afii10044 /afii10045 /afii10046 /afii10047 /afii10048 /afii10049
  /afii10065 /afii10066 /afii10067 /afii10068 /afii10069 /afii10070 /afii10072 /afii10073
  /afii10074 /afii10075 /afii10076 /afii10077 /afii10078 /afii10079 /afii10080 /afii10081
  /afii10082 /afii10083 /afii10084 /afii10085 /afii10086 /afii10087 /afii10088 /afii10089
  /afii10090 /afii10091 /afii10092 /afii10093 /afii10094 /afii10095 /afii10096 /afii10097
] def
/CP1253Encoding [
  /null /controlSTX /controlSOT /controlETX /controlEOT /controlENQ /controlACK /controlBEL
  /controlBS /controlHT /controlLF /controlVT /controlFF /controlCR /controlSO /controlSI
  /controlDLE /controlDC1 /controlDC2 /controlDC3 /controlDC4 /controlNAK /controlSYN /controlETB
  /controlCAN /controlEM /controlSUB /controlESC /controlFS /controlGS /controlRS /controlUS
  /space /exclam /quotedbl /numbersign /dollar /percent /ampersand /quotesingle
  /parenleft /parenright /asterisk /plus /comma /hyphen /period /slash
  /zero /one /two /three /four /five /six /seven
  /eight /nine /colon /semicolon /less /equal /greater /question
  /at /A /B /C /D /E /F /G
  /H /I /J /K /L /M /N /O
  /P /Q /R /S /T /U /V /W
  /X /Y /Z /bracketleft /backslash /bracketright /asciicircum /underscore
  /grave /a /b /c /d /e /f /g
  /h /i /j /k /l /m /n /o
  /p /q /r /s /t /u /v /w
  /x /y /z /braceleft /bar /braceright /asciitilde /controlDEL
  /Euro /null /quotesinglbase /florin /quotedblbase /ellipsis /dagger /daggerdbl
  /null /perthousand /null /guilsinglleft /null /null /null /null
  /null /quoteleft /quoteright /quotedblleft /quotedblright /bullet /endash /emdash
  /null /trademark /null /guilsinglright /null /null /null /null
  /nbspace /dialytikatonos /Alphatonos /sterling /currency /yen /brokenbar /section
  /dieresis /copyright /null /guillemotleft /logicalnot /sfthyphen /registered /afii00208
  /degree /plusminus /twosuperior /threesuperior /tonos /mu /paragraph /middot
  /Epsilontonos /Etatonos /Iotatonos /guillemotright /Omicrontonos /onehalf /Upsilontonos /Omegatonos
  /iotadieresistonos /Alpha /Beta /Gamma /Deltagreek /Epsilon /Zeta /Eta
  /Theta /Iota /Kappa /Lambda /Mu /Nu /Xi /Omicron
  /Pi /Rho /null /Sigma /Tau /Upsilon /Phi /Chi
  /Psi /Omegagreek /Iotadieresis /Upsilondieresis /alphatonos /epsilontonos /etatonos /iotatonos
  /upsilondieresistonos /alpha /beta /gamma /delta /epsilon /zeta /eta
  /theta /iota /kappa /lambda /mu /nu /xi /omicron
  /pi /rho /sigma1 /sigma /tau /upsilon /phi /chi
  /psi /omega /iotadieresis /upsilondieresis /omicrontonos /upsilontonos /omegatonos /null
] def

% перевод из миллиметров в пункты
/mm { 72.0 mul 25.4 div } def

/size_of_BBox % [ x1 x2 y1 y2 ] --> x2-x1  y2-y1
{
  dup type  /arraytype  eq  { aload pop } if
  exch  3 1 roll
  sub neg
  3 1 roll
  sub neg
  exch
} bind def

/size_of_BBox_def % /sizeX /sizeY [ x1 x2 y1 y2 ] --> - ; /sizeX = x2-x1; /sizeY = y2-y1;
{
  size_of_BBox
  3 -1 roll exch def
  def
} def

/tan 
{
  dup
  sin
  exch cos
  div
} bind def

/areverse  %  [a b ... z] --> [z ... b a]
{
  [ exch
    aload
    length
    2  1  3 -1 roll
      {
        -1 roll
      }
    for
  ]
} bind def

/aconcatenate  %  [(a) (b) ... (z)] --> (ab...z)
{
  0  1 index  { length add } forall  string
  0 3 2 roll
    {
      3 copy putinterval
      length add
    }
  forall pop  
} bind def

/aeq % array1 array2 aeq --> bool 
{
    2 copy eq
    { pop pop true }
    {
        2 copy length exch length eq 
        {
          true % arr arr true
            0  1  3 index length 1 sub
            {
              3 index 1 index get % arr arr bool index val1
              3 index 2 index get % arr arr bool index val1 val2
              eq exch pop and % arr arr bool 
            }
          for
          exch pop exch pop
        }
        { pop pop false }
      ifelse
    }
  ifelse
} bind def

/stringheight
{
  gsave
    newpath
    0 0 moveto
    false charpath pathbbox exch pop sub exch pop
  grestore
} bind def

/string_center_bottom
{
  dup
    stringwidth pop  2 div  neg
    0
  rmoveto
} bind def

/string_center_middle
{
  dup
    dup stringwidth pop 2 div neg
    exch stringheight 2 div
  rmoveto
} bind def

/string_left_middle
{
  dup
    0
    exch stringheight 2 div
  rmoveto
} bind def

/string_right_middle
{
  dup
    dup stringwidth pop neg
    exch stringheight 2 div
  rmoveto
} bind def

/arc_angle_from
{
  5 dict begin
  /y1 exch def
  /x1 exch def
  /r exch def
  /yc exch def
  /xc exch def
    xc yc r
    y1 yc sub  x1 xc sub  atan
  end
} bind def

/arc_angle_to
{
  6 dict begin
  /y2 exch def
  /x2 exch def
  /a1 exch def
  /r exch def
  /yc exch def
  /xc exch def
    xc yc r a1
    y2 yc sub  x2 xc sub  atan
  end
} bind def

/int_to_roman % 4 --> (IV)
{
  1 dict begin
  /n_int exch def

  [
      [
        << /i (I)  /v (V)  /x (X) >>
        << /i (X)  /v (L)  /x (C) >>
        << /i (C)  /v (D)  /x (M) >>
        << /i (M) >>
      ]
      {
        n_int 0 eq { pop exit } if
        begin
          [
              [ {} {i} {i i} {i i i} {i v} {v} {v i} {v i i} {v i i i} {i x} ]
              n_int 10 mod
            get
            exec
          ]
        aconcatenate
        end
        /n_int  n_int 10 idiv  def
      }
    forall
  ]
  areverse
  aconcatenate

  end
} bind def

/range % 1 5 --> 1 2 3 4 5
{
  2 dict begin
  /n_to exch def
  /n_from exch def
  n_from 1 n_to {} for
  end
} bind def

/months % [ 1 2 3 ] --> (1) (2) (3)
{
  { 2 string  cvs } forall
} bind def
% [ 1 12 range ]  months ==

/quarters % [ 1 2 3 4 ] --> (I) (II) (III) (IV)
{
  { int_to_roman } forall
} bind def
% [ 1 4 range ]  quarters == 

/year % --> ()
{
  ()
} bind def

(GOST2.304-81TypeA) findfont
dup length dict begin
  { 1 index /FID ne
    {def}
    {pop pop}
    ifelse
  } forall
  /Encoding CP1251Encoding def
  currentdict
end
(stamp_sign_cyr) exch definefont pop

(GOST2.304-81TypeA) findfont
dup length dict begin
  { 1 index /FID ne
    {def}
    {pop pop}
    ifelse
  } forall
  /Encoding CP1253Encoding def
  currentdict
end
(stamp_sign_greek) exch definefont pop

(GOST2.304-81TypeA) findfont
dup length dict begin
  { 1 index /FID ne
    {def}
    {pop pop}
    ifelse
  } forall
  /Encoding CP1251Encoding def
  currentdict
end
(stamp_id) exch definefont pop

(GOST2.304-81TypeA) findfont
(stamp_period) exch definefont pop

(GOST2.304-81TypeA) findfont
(stamp_year) exch definefont pop

(GOST2.304-81TypeA) findfont
(stamp_K) exch definefont pop

/path_as_upath % path_generator bool --> userpath
{
  1 dict begin
  /cache_upath exch def
  gsave
  newpath
  0 0 moveto
  load exec
  cache_upath upath
  grestore
  end
} def

/stamp_sign_path_helper % (sign) angle --> - (добавляем к текущему пути путь знака поверителя)
{
  1 dict begin
  /savedCTM matrix currentmatrix def
  rotate
  gsave
    currentpoint
    newpath
    moveto
    dup  true charpath
    flattenpath pathbbox
  grestore
  3 -1 roll sub neg 2 div  3 1 roll sub 2 div  exch  rmoveto
  true charpath
  savedCTM setmatrix
  end
} def

/stamp_sign_upath_helper % (sign) angle --> upath
{
  /stamp_sign_path_helper
  true path_as_upath
} def

/stamp_signs_cyr [
  (а) (б) (в) (г) (д) (е) (ж) (з)
  (и) (й) (к) (л) (м) (п) (р) (с)
  (т) (у) (ф) (ц) (ч) (ш) (щ) (ъ)
  (ы) (ь) (э) (ю) (я) (b) (d) (f)
  (g) (h) (i) (j) (k) (r) (s) (t)
  (v) (w)
] def

/stamp_signs_greek [
          (б) (в) (г) (д) (ж) (з)
  (и) (й) (к) (л) (м) (н) (о) (р)
  (с) (у) (ф) (х) (ц) (ч) (ш) (щ)
] def

gsave

/stamp_signs_upaths [
  1 dict begin
    [ 0 180 90 270 ]
    {
      /angle exch def
      
      (stamp_sign_cyr) findfont
      4 scalefont setfont
        stamp_signs_cyr
        {
          angle stamp_sign_upath_helper
        }
      forall

      (stamp_sign_greek) findfont
      4 scalefont setfont
        stamp_signs_greek
        {
          angle stamp_sign_upath_helper
        }
      forall
    }
  forall
  end
] def

grestore

/stamp_sign_upath % sign_N --> upath
{
  stamp_signs_upaths  exch 1 sub  get
} def

% знак РСТ
/RST % H_size --> -
{
  10 dict begin
  /H exch def % параметр H (высота) знака
  /x1  15 tan  H 2 div  mul  neg  def
  /R1  H  H 2 div  15 cos  div  sub  def
  /x2  0.17 H mul  def
  /y2  R1 dup mul  x2 x1 sub  dup mul  sub  sqrt  def
  /R2  y2  0.25 H mul  add  def
  /x4  0.5 H mul  def
  /y4  3 sqrt  2 div  H mul  H 2 div  sub  def
  /x5  x4  def
  /y5  R2 dup mul  x5 x2 sub  dup mul  sub  sqrt  y2 sub  def
  
  % сохраняем на стеке текущую матрицу преобразования системы координат для последующего восстановления
  matrix currentmatrix
  % переносим начало координат в центр символа РСТ
  currentpoint translate

  % С
  x4 y4 moveto
    0  H 2 div neg  H
    x4 y4 arc_angle_from
    105
  arc
  x1 0 R1 105 255 arc
    0  H 2 div  H
    255
    x4  y4 neg  arc_angle_to
  arc
  x5  y5 neg  lineto
    x2 y2 R2
    x5  y5 neg  arc_angle_from
    270
  arcn
  x2 0  0.25 H mul  270 90 arcn
    x2  y2 neg  R2
    90
    x5 y5  arc_angle_to
  arcn
  closepath
  
  % Т
    0.5  0.18 2 div  add  H mul
    0.25 H mul  2 div  neg
  moveto
  0  0.25 0.1 sub  H mul  rlineto
  0.35 0.18 sub  2 div  H mul  0  rlineto
  0  0.1 H mul  rlineto
  0.35 H mul neg  0  rlineto
  0  0.1 H mul neg  rlineto
  0.35 0.18 sub  2 div  H mul  0  rlineto
  0  0.25 0.1 sub  H mul  neg  rlineto
  closepath
  
  % р
    0.31 0.08 add H mul neg
    0.28 H mul neg
  moveto
    0.31 0.08 add H mul neg
    0.28 0.1 sub H mul neg
    0.1 H mul
    270 180
  arcn
  0  0.18 0.1 add H mul  rlineto
    0.31 H mul neg
    0.1 H mul
    0.18 H mul
    180
    -0.18  0.08 0.04 sub neg  atan
  arcn
  %  0  0.1 H mul  rlineto
    0.31 H mul neg
    0.1 H mul
    0.08 H mul
    -0.08  0.08 0.04 sub neg  atan
    180
  arc
  closepath

  % восстановливаем систему координат
  setmatrix

  end
} bind def

/urst  1 /RST true path_as_upath  cvlit def

% генерация рисунка поверительного клейма
/verification_stamp_path % диаметр знак_поверителя (шифр клейма) (период) год --> -
{
  6 dict begin
  /size exch def % размер клейма
  /verification_stamp_sign exch def % индивидуальный знак поверителя
  /verification_stamp_id exch def % шифр поверительного клейма
  /verification_stamp_period exch def % идентификация периода для месячных и квартальных клейм
  /verification_stamp_year exch def % год поверительного клейма
  /scale_k size 18 div def % рассчитаем коэффициент для последующего масштабирования

  % сохраняем на стеке текущую матрицу преобразования системы координат для последующего восстановления
  matrix currentmatrix
  currentpoint translate
  scale_k scale_k scale
  9 9 translate

  % окружность
  18 2 div  0  moveto
  0 0  18 2 div  0 360 arc  closepath
  18 2 div 0.5 sub  0  moveto
  0 0  18 2 div 0.5 sub  360 0 arcn  closepath
  
  % шифр поверительного клейма организации
  (stamp_id) findfont
  4 scalefont setfont
  0 -5.5 moveto
    verification_stamp_id
    string_center_middle
  true charpath

  % индивидуальный знак поверителя
  matrix currentmatrix
  0 0 moveto
  1 1 scale
  verification_stamp_sign stamp_sign_upath uappend
  setmatrix
  
  % год
  (stamp_year) findfont
  6 scalefont setfont
  -7 0 moveto
        verification_stamp_year 4 string cvs
        dup length 2 sub
        1
      getinterval
    string_left_middle 
  true charpath
  7 0 moveto
        verification_stamp_year 4 string cvs
        dup length 1 sub
        1
      getinterval
    string_right_middle 
  true charpath

    verification_stamp_period () eq
    {
      % знак РСТ
      0 5 moveto
      currentpoint translate
      3 3 scale
      urst uappend
    }
    {
      % период
      (stamp_period) findfont
      3 scalefont setfont
      -2.5 5 moveto
        verification_stamp_period
        string_center_middle
      true charpath

      % знак РСТ
      2.5 5 moveto
      currentpoint translate
      3 3 scale
      urst uappend
    }
  ifelse
  
  % восстановливаем систему координат
  setmatrix

  end
} bind def

/verification_stamp_upath % диаметр знак_поверителя (шифр клейма) (период) год --> user path
{
  /verification_stamp_path
  false path_as_upath
} def

% знак калибровки
/K % H_size --> -
{
  currentpoint
  matrix currentmatrix
  
  currentpoint translate

  (stamp_K) findfont
  5 -1 roll  scalefont  setfont
    (K)
    string_center_middle
  true charpath

  % восстановливаем систему координат
  setmatrix
  moveto
} bind def

/uK 1 /K true path_as_upath  cvlit def

% генерация рисунка калибровочного клейма
/calibration_stamp_path % размер знак_поверителя (шифр клейма) (период) год --> user path
{
  6 dict begin
  /size exch def % размер клейма
  /stamp_sign exch def % индивидуальный знак поверителя
  /stamp_id exch def % шифр клейма
  /stamp_period exch def % идентификация периода для месячных и квартальных клейм
  /stamp_year exch def % год клейма
  /scale_k size 18 div def % рассчитаем коэффициент для последующего масштабирования

  % сохраняем на стеке текущую матрицу преобразования системы координат для последующего восстановления
  matrix currentmatrix
  currentpoint translate
  scale_k scale_k scale
  9 9 translate

  % квадрат
  18 2 div neg  dup  moveto
  18 0 rlineto
  0 18 rlineto
  -18 0 rlineto
  closepath
  0.5 0.5 rmoveto
  0 17 rlineto
  17 0 rlineto
  0 -17 rlineto
  closepath
  
  % шифр клейма организации
  (stamp_id) findfont
  4 scalefont setfont
  0 -5.5 moveto
    stamp_id
    string_center_middle
  true charpath

  % индивидуальный знак поверителя
  matrix currentmatrix
    2.5 5 moveto
    currentpoint translate
    1 1 scale
    stamp_sign stamp_sign_upath uappend
  setmatrix
  
  % год
  (stamp_year) findfont
  6 scalefont setfont
  -7 0 moveto
        stamp_year 4 string cvs
        dup length 2 sub
        1
      getinterval
    string_left_middle 
  true charpath
  7 0 moveto
        stamp_year 4 string cvs
        dup length 1 sub
        1
      getinterval
    string_right_middle 
  true charpath

  % период
  (stamp_period) findfont
  3 scalefont setfont
  -2.5 5 moveto
    stamp_period
    string_center_middle
  true charpath

  % знак калибровки
  0 0 moveto
  currentpoint translate
  6 6 scale
  uK uappend
  
  % восстановливаем систему координат
  setmatrix

  end
} bind def

/calibration_stamp_upath % размер знак_поверителя (шифр клейма) (период) год --> user path
{
  /calibration_stamp_path
  false path_as_upath
} def

/create_stamps % год [массив периодов] (шифр клейма) [массив знаков поверителей] размер функция_генерации  --> выполнение функции генерации для всех заданных клейм
{
  8 dict begin
  /stamp_functor exch def
  /size exch def % размер клейма
  /verification_stamp_sign exch def % индивидуальный знак поверителя
  /verification_stamp_id exch def % шифр поверительного клейма
  /verification_stamp_period exch def % идентификация периода для месячных и квартальных клейм
  /verification_stamp_year exch def % год поверительного клейма

      verification_stamp_period type /arraytype eq
      { verification_stamp_period }
      { [ verification_stamp_period ] }
    ifelse
    {
      /verification_stamp_current_period exch def
      
          verification_stamp_sign type /arraytype eq
          { verification_stamp_sign }
          { [ verification_stamp_sign ] }
        ifelse
        {
          /verification_stamp_current_sign exch def
            verification_stamp_year
            verification_stamp_current_period
            verification_stamp_id
            verification_stamp_current_sign
            size
          stamp_functor load exec
        }
      forall
    }
  forall
  
  end
} def

/upath_BBox % upath --> x1 y1 x2 y2
{
  gsave
    newpath
    0 0 moveto
    uappend flattenpath pathbbox
  grestore
} bind def

/draw_stamps % [ upath ... upath ] [ bounding box ] gap --> - (отрисованные штампы)
{
  20 dict begin
  /gap exch def
  /BBox exch def
  /stamps exch def
  /stamps_length  stamps length  def
  /current_stamp_index 0 def
  /BBox_SizeX /BBox_SizeY  BBox  size_of_BBox_def
  
  /no_prev_line_props <<
    /line_height 0
    /possible_staggered_align_for_next_line false
    /possible_staggered_align false
    /ItemSize null
    /is_odd_line false
  >> def
  
  /new_line_props  no_prev_line_props  dup length dict  copy  def
  new_line_props begin
    /possible_staggered_align_for_next_line true def
  end
  
  /current_line_props  new_line_props  dup length dict  copy  def
  /prev_line_props  no_prev_line_props  dup length dict  copy  def
  
  /setup_new_page
  {
    BBox aload pop pop pop  translate
    newpath
    0 0 moveto
    /prev_line_props  no_prev_line_props  dup length dict  copy  def
    current_line_props begin
      /possible_staggered_align false def
      /is_odd_line false def
    end
  } def
  
  /is_EOL
  {
      current_stamp_index stamps_length ge
      { true }
      {
          currentpoint pop  current_stamp_SizeX  add
            current_line_props /is_odd_line get
            { current_line_props /ItemSize get  0 get  gap add  2 div  add }
          if
          BBox_SizeX
        gt
      }
    ifelse
  } def
  
  /is_EOP
  {
      currentpoint exch pop  current_line_props /line_height get  add
        current_line_props /possible_staggered_align get
        {
              current_line_props /ItemSize get  1 get  gap add
              3 sqrt  2 div  1 sub
            mul
          add
        }
      if
      BBox_SizeY
    gt
  } def
  
  matrix currentmatrix
    setup_new_page
      {
          current_stamp_index stamps_length lt
          {
            /current_stamp { stamps current_stamp_index get } def
            /current_stamp_BBox  [ current_stamp upath_BBox ]  def
            /current_stamp_Size [ current_stamp_BBox size_of_BBox ] def
            /current_stamp_SizeX /current_stamp_SizeY  current_stamp_BBox  size_of_BBox_def
          }
        if
          
          is_EOP
          {
            false upath
              showpage
              setup_new_page
            uappend
            currentpoint pop  0  moveto
          }
        if

          is_EOL
          {
            false upath % сохранили текущую строку в user path
            
            matrix currentmatrix
                current_line_props /possible_staggered_align get
                {
                    0
                      current_line_props /ItemSize get  1 get  gap add
                      3 sqrt  2 div  1 sub
                    mul
                  rmoveto
                  current_line_props /is_odd_line get
                  {
                      current_line_props /ItemSize get  0 get  gap add  2 div
                      currentpoint exch pop
                    translate
                  }
                  {
                      0
                      currentpoint exch pop
                    translate
                  }
                  ifelse
                }
                {
                    0
                    currentpoint exch pop
                  translate
                }
              ifelse
              0 0 moveto
              2 -1 roll
              ufill
            setmatrix
            
              0
              currentpoint exch pop  current_line_props /line_height get  add  gap add
                newpath % готовим новую строку
            moveto
            
            /prev_line_props  current_line_props  dup length dict  copy  def
            /current_line_props  new_line_props  dup length dict  copy  def
            current_line_props begin
              prev_line_props /possible_staggered_align_for_next_line get  dup  /possible_staggered_align exch def
                {
                  /is_odd_line prev_line_props /is_odd_line get not  def
                }
              if
            end
          }
        if
        current_stamp_index stamps_length ge { exit } if
        currentpoint
        matrix currentmatrix
          currentpoint pop  0  moveto % рисуем строку с y=0
            current_stamp_BBox 0 get neg
            current_stamp_BBox 1 get neg
          rmoveto
          currentpoint translate
          current_stamp uappend
        setmatrix
        moveto
        current_line_props begin
          current_stamp_SizeY  line_height  gt  { /line_height current_stamp_SizeY def } if
            possible_staggered_align_for_next_line
            {
                null ItemSize eq
                { /ItemSize current_stamp_Size def }
                {
                    ItemSize current_stamp_Size aeq not
                    {
                      % (Вывод в шахматном порядке невозможен: ) ==  ItemSize ==  current_stamp_Size ==
                      /possible_staggered_align_for_next_line false def
                      /possible_staggered_align false def
                      /is_odd_line false def
                    }
                  if
                  % todo: здесь добавить сравнение формы оттиска с кругом
                    gsave
                        current_stamp
                          newpath
                          current_stamp_BBox aload pop pop pop  moveto
                          gap neg  gap neg  rmoveto
                          0  current_stamp_SizeY gap 2 mul add  rlineto
                          current_stamp_SizeX gap 2 mul add  0  rlineto
                          0  current_stamp_SizeY gap 2 mul add neg  rlineto
                          closepath
                              current_stamp_BBox aload pop  3 -1 roll
                            add 2 div
                              3 1 roll  add 2 div  current_stamp_SizeX 2 div  gap 2 div add  add
                            exch
                          moveto
                              current_stamp_BBox aload pop  3 -1 roll
                            add 2 div
                              3 1 roll  add 2 div
                            exch
                            current_stamp_SizeX 2 div  gap 2 div add
                            0
                            360
                          arc
                        false upath
                      inufill
                    grestore
                    {
                      % (Вывод в шахматном порядке невозможен: форма объекта не вписывается в круг.)
                      /possible_staggered_align_for_next_line false def
                      /possible_staggered_align false def
                      /is_odd_line false def
                    }
                  if
                }
              ifelse
            }
          if
            possible_staggered_align
            {
                ItemSize  prev_line_props /ItemSize get  aeq not
                {
                  % (Вывод в шахматном порядке невозможен (размеры элемента с предыщей строкой не совпадают): ) ==  ItemSize ==  prev_line_props /ItemSize get ==
                  /possible_staggered_align false def
                  /is_odd_line false def
                }
              if
            }
          if
        end
        current_stamp_SizeX gap add  0  rmoveto
        /current_stamp_index current_stamp_index 1 add def
      }
    loop
  setmatrix

  end
} bind def

%%EndProlog

%%BeginSetup
%%EndSetup

%%Page: A 1
%%BeginSetup
%%BeginFeature: *PageSize A5
<<
  % /HWResolution [2400 2400]
  /PageSize [ 210 mm  297 2 div mm ]
  /ImagingBBox [ 5 mm  5 mm  210 5 sub mm  297 2 div 5 sub mm ]
  /MirrorPrint false
  /NegativePrint true
>> setpagedevice
%%EndFeature
%%EndSetup

gsave

% 210 mm 0 mm translate
% 90 rotate

  % GetPageBBox
  % [ 20 mm  dup 3 sqrt 2 div mul ]
% align_staggered

  [
      2017
      % [ [ 1 2  3 6 range  10 ] months  [ 1 4 range ] quarters ]
      [ [ 3 ] quarters ]
      (СП)
      [ 1 256 range ]
      18.0 mm
      /verification_stamp_upath
    create_stamps
      2017
      [ [ 1 12  range ] months  [ 1 4 range ] quarters year ]
      % [ [ 3 ] quarters ]
      (СП)
      [ 1 ]
      18.0 mm
      /calibration_stamp_upath
    create_stamps
  ]
  GetPageBBox
  2 mm
draw_stamps

grestore

showpage

%%EOF
