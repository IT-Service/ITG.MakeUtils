%!PS-Adobe-2.0
%%Creator: Sergei S. Betke
%%Title: CSM makrs
%%Pages: 1
%%PageOrder: Ascend
%%BoundingBox: 0 0 585 842
%%EndComments

% перевод из миллиметров в пункты
/mm { 72.0 mul 25.4 div } def

/tan {
  dup
  sin
  exch cos
  div
}
def

/stringheight {
  gsave
    newpath
    0 0 moveto
    false charpath pathbbox exch pop sub exch pop
  grestore
}
def

/string_center_bottom {
  dup
    stringwidth pop  2 div  neg
    0
  rmoveto
}
def

/string_center_middle {
  dup
    dup stringwidth pop 2 div neg
    exch stringheight 2 div
  rmoveto
}
def

/string_left_middle {
  dup
    0
    exch stringheight 2 div
  rmoveto
}
def

/string_right_middle {
  dup
    dup stringwidth pop neg
    exch stringheight 2 div
  rmoveto
}
def

% знак РСТ
/RST {
  1 dict begin
  /H exch def % параметр H (высота) знака
  gsave
  
  currentpoint translate

  % окружность
  newpath
  0  H 2 div neg  H  90 0.5 1 atan sub  105  arc
    15 cos H mul  H 2 div  sub  15 tan  div  neg  15 sin H mul  sub
    0
    15 sin H mul  neg
    H 2 div  15 cos H mul  sub
    H  H 2 div  15 cos  div  sub
  arct
  0  H 2 div  H  255  270 0.5 1 atan add  arc
  closepath
    
  eofill

  grestore
  end
}
def

% генерация рисунка поверительного клейма
/verification_stamp {
  6 dict begin
  /size exch def % размер клейма
  /verification_stamp_sign exch def % индивидуальный знак поверителя
  /verification_stamp_id exch def % шифр поверительного клейма
  /verification_stamp_period exch def % идентификация периода для месячных и квартальных клейм
  /verification_stamp_year exch def % год поверительного клейма
  /scale_k size 18 div def % рассчитаем коэффициент для последующего масштабирования
  gsave

  scale_k scale_k scale % масштабируем пространство для отрисовки из 18 единиц в заданный размер клейма

  % окружность
  newpath
  0 0  18 2 div  0 360 arc
  0 0  18 2 div 1 sub  0 360 arc

  % шифр поверительного клейма организации
  /Helvetica findfont
  4 scalefont setfont
  0 -5.5 moveto
    verification_stamp_id
    string_center_middle
  false charpath

  % индивидуальный знак поверителя
  /Helvetica findfont
  4 scalefont setfont
  0 0 moveto
    verification_stamp_sign
    string_center_middle 
  false charpath
  
  % год
  /Helvetica findfont
  6 scalefont setfont
  -7 0 moveto
        verification_stamp_year 4 string cvs
        dup length 2 sub
        1
      getinterval
    string_left_middle 
  false charpath
  7 0 moveto
        verification_stamp_year 4 string cvs
        dup length 1 sub
        1
      getinterval
    string_right_middle 
  false charpath

  % период
  /Helvetica findfont
  3 scalefont setfont
  -2.5 5 moveto
    verification_stamp_period
    string_center_middle
  false charpath
  
  % знак РСТ
  2.5 5 moveto
  3 RST

  eofill

  grestore
  end
}
def

% генерация рисунка калибровочного клейма
/calibration_stamp {
}
def

%%EndProlog

%%BeginSetup
%%Feature: *Resolution 600dpi
%%EndSetup

%%Page: A 1
%%BeginSetup
%%BeginFeature: *PageSize A4
<</PageSize [595 842] /ImagingBBox null>> setpagedevice
%%EndFeature
%%EndSetup

% начальные служебные инструкции закончены

gsave

30 mm 230 mm translate % передвинем начало отсчета

2017 (IV) (CT) (A) 40.0 mm verification_stamp

% glyphshow

grestore
showpage

%%PageTrailer
%%Trailer
%%EOF
